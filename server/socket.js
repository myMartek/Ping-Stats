import moment from 'moment';
import ping from 'ping';

// TODO: removed default locations
let locations = [{ address: '10.0.0.1', history: [[1669017852000, 2.023], [1669017852000, 1.616], [1669017853000, 1.258], [1669017853000, 1.612], [1669017854000, 1.829], [1669017854000, 2.037], [1669017855000, 1.364], [1669017855000, 1.363], [1669017856000, 1.481], [1669017856000, 1.632], [1669017857000, 1.541], [1669017857000, 1.646], [1669017858000, 1.635], [1669017858000, 40], [1669017859000, 40], [1669017859000, 40], [1669017860000, null], [1669017860000, null], [1669017861000, null], [1669017861000, null], [1669017862000, 40], [1669017863000, 39], [1669017863000, 1.789], [1669017864000, 1.698], [1669017864000, 1.377], [1669017865000, 1.495], [1669017865000, 1.787], [1669017866000, 1.72], [1669017866000, 1.408], [1669017867000, 1.779], [1669017867000, 1.489], [1669017868000, 1.969], [1669017868000, 1.872], [1669017869000, 1.572], [1669017869000, 2.315], [1669017870000, 2.095], [1669017870000, 1.603], [1669017871000, 1.391], [1669017871000, 1.91], [1669017872000, 2.034], [1669017872000, 1.419], [1669017873000, 1.416], [1669017873000, 1.714], [1669017874000, 1.667], [1669017874000, 1.865], [1669017875000, 1.453], [1669017875000, 1.806], [1669017876000, 1.355], [1669017877000, 2.012], [1669017877000, 1.404], [1669017878000, 1.823], [1669017878000, 1.493], [1669017879000, 1.379], [1669017879000, 1.545], [1669017880000, 1.495], [1669017880000, 2.127], [1669017881000, 1.957], [1669017881000, 1.594], [1669017882000, 1.414], [1669017882000, 1.599], [1669017883000, 1.688], [1669017883000, 2.404], [1669017884000, 1.735], [1669017884000, 1.433], [1669017885000, 1.705], [1669017885000, 1.934], [1669017886000, 1.599], [1669017886000, 1.679], [1669017887000, 1.483], [1669017887000, 1.27], [1669017888000, 1.588], 1669017914000, [1669017914000, 1.969], [1669017914000, 1.85], [1669017915000, 1.881], [1669017915000, 2.134], [1669017916000, 2.419], [1669017916000, 1.519], [1669017917000, 2.129], [1669017918000, 1.656], [1669017918000, 1.83], [1669017919000, 1.527], [1669017919000, 1.495], [1669017920000, 1.613], [1669017920000, 1.896], [1669017921000, 1.769], [1669017921000, 1.519], [1669017922000, 1.486], [1669017922000, 1.556], [1669017923000, 1.703], [1669017923000, 1.356], [1669017924000, 1.63], [1669017924000, 1.584], [1669017925000, 1.568], [1669017925000, 1.444], [1669017926000, 2.282], [1669017926000, 1.907], [1669017927000, 1.96], [1669017927000, 1.273], [1669017928000, 2.495], [1669017928000, 1.464], [1669017929000, 1.835], [1669017929000, 1.506], [1669017930000, 1.361], [1669017931000, 1.547], [1669017931000, 1.982], [1669017932000, 1.557], [1669017932000, 1.299], [1669017933000, 1.446], [1669017933000, 1.783], [1669017934000, 1.443], [1669017934000, 1.597], [1669017935000, 1.471], [1669017935000, 1.913], [1669017936000, 1.481], [1669017936000, 1.424], [1669017937000, 2.297], [1669017937000, 1.879], [1669017938000, 1.486], [1669017938000, 1.701], [1669017939000, 1.593], [1669017939000, 1.47], [1669017940000, 1.379], [1669017940000, 1.59], [1669017941000, 1.502], [1669017941000, 1.739], [1669017942000, 1.54], [1669017942000, 1.382], [1669017943000, 1.636], [1669017943000, 1.272], [1669017944000, 1.599], [1669017945000, 1.395], [1669017945000, 1.547], [1669017946000, 1.699], [1669017946000, 1.837], [1669017947000, 1.41], [1669017947000, 1.351], [1669017948000, 1.208], [1669017948000, 1.565], [1669017949000, 1.413], [1669017949000, 1.924], [1669017950000, 1.523], [1669017950000, 1.761], [1669017951000, 1.476], [1669017951000, 1.565], [1669017952000, 1.355], [1669017952000, 1.432], [1669017953000, 1.561], [1669017953000, 1.508], [1669017954000, 1.514], [1669017954000, 2.071], [1669017955000, 2.339], [1669017955000, 1.363], [1669017956000, 1.497], [1669017956000, 1.443], [1669017957000, 2.228], [1669017958000, 1.468], [1669017958000, 1.652], [1669017959000, 1.615], [1669017959000, 1.459], [1669017960000, 1.541], [1669017960000, 1.549], [1669017961000, 1.643], [1669017961000, 1.826], [1669017962000, 2.005], [1669017962000, 1.577], [1669017963000, 1.454], [1669017963000, 1.277], [1669017964000, 2.21], [1669017964000, 1.793], [1669017965000, 1.515], [1669017965000, 1.527], [1669017966000, 1.644], [1669017966000, 1.722], [1669017967000, 1.775], [1669017967000, 1.661], [1669017968000, 1.56], [1669017968000, 2.26], [1669017969000, 1.708], [1669017969000, 1.822], [1669017970000, 1.658], [1669017970000, 1.517], [1669017971000, 1.66], [1669017972000, 1.66], [1669017972000, 1.507], [1669017973000, 1.496], [1669017973000, 2.441], [1669017974000, 1.302], [1669017974000, 2.316], [1669017975000, 1.561], [1669017975000, 1.746], [1669017976000, 1.393], [1669017976000, 1.328], [1669017977000, 1.553], [1669017977000, 1.415], [1669017978000, 1.648], [1669017978000, 1.69], [1669017979000, 1.422], [1669017979000, 1.85], [1669017980000, 3.091], [1669017980000, 1.842], [1669017981000, 1.788], [1669017981000, 1.188], [1669017982000, 1.717], [1669017982000, 1.424], [1669017983000, 1.292], [1669017983000, 1.688], [1669017984000, 1.439], [1669017985000, 1.555], [1669017985000, 1.676], [1669017986000, 1.597], [1669017986000, 1.521], [1669017987000, 1.45], [1669017987000, 1.536], [1669017988000, 2.066], [1669017988000, 1.368], [1669017989000, 1.741], [1669017989000, 1.65], [1669017990000, 1.524], [1669017990000, 1.476], [1669017991000, 1.961], [1669017991000, 1.363], [1669017992000, 1.912], [1669017992000, 1.287], [1669017993000, 1.406], [1669017993000, 1.782], [1669017994000, 1.459], [1669017994000, 1.677], [1669017995000, 1.763], [1669017995000, 1.391], [1669017996000, 1.911], [1669017996000, 1.493], [1669017997000, 1.466], [1669017998000, 1.359], [1669017998000, 1.269], [1669017999000, 1.301], [1669017999000, 1.566], [1669018000000, 1.742], [1669018000000, 2.469], [1669018001000, 1.963], [1669018001000, 1.558], [1669018002000, 1.607], [1669018002000, 1.378], [1669018003000, 1.48], [1669018003000, 1.723], [1669018004000, 2.246], [1669018004000, 2.056], [1669018005000, 1.338], [1669018005000, 2.061], [1669018006000, 1.422], [1669018006000, 1.815], [1669018007000, 1.76], [1669018007000, 1.34], [1669018008000, 1.463], [1669018008000, 1.888], [1669018009000, 1.794], [1669018009000, 1.507], [1669018010000, 1.609], [1669018010000, 1.238], [1669018011000, 2.659], [1669018011000, 1.552], [1669018012000, 1.795], [1669018013000, 1.62], [1669018013000, 1.47], [1669018014000, 1.438], [1669018014000, 1.87], [1669018015000, 2.946], [1669018015000, 1.429], [1669018016000, 1.339], [1669018016000, 1.41], [1669018017000, 1.931], [1669018017000, 1.485], [1669018018000, 1.523], [1669018018000, 1.834], [1669018019000, 1.515], [1669018019000, 1.579], [1669018020000, 1.922], [1669018020000, 1.371], [1669018021000, 1.354]] }, { address: '10.10.10.1', history: [[1669017852000, 1.74], [1669017852000, 1.672], [1669017853000, 2.115], [1669017853000, 2.416], [1669017854000, 2.673], [1669017854000, 2.248], [1669017855000, 2.559], [1669017855000, 1.992], [1669017856000, 2.051], [1669017856000, 2.3], [1669017857000, 2.277], [1669017857000, 1.973], [1669017858000, 2.108], [1669017858000, 1.914], [1669017859000, 1.574], [1669017859000, 1.89], [1669017860000, 2.192], [1669017860000, 2.241], [1669017861000, 2.411], [1669017861000, 2.229], [1669017862000, 1.975], [1669017863000, 2.266], [1669017863000, 1.609], [1669017864000, 1.992], [1669017864000, 2.379], [1669017865000, 2.001], [1669017865000, 2.055], [1669017866000, 2.013], [1669017866000, 1.954], [1669017867000, 1.947], [1669017867000, 2.043], [1669017868000, 2.53], [1669017868000, 2.533], [1669017869000, 2.821], [1669017869000, 2.656], [1669017870000, 2.763], [1669017870000, 2.231], [1669017871000, 1.825], [1669017871000, 1.99], [1669017872000, 2.547], [1669017872000, 1.969], [1669017873000, 2.338], [1669017873000, 3.326], [1669017874000, 2.047], [1669017874000, 1.912], [1669017875000, 3.82], [1669017875000, 3.205], [1669017876000, 1.613], [1669017877000, 2.477], [1669017877000, 2.184], [1669017878000, 3.109], [1669017878000, 2.321], [1669017879000, 1.719], [1669017879000, 2.115], [1669017880000, 2.786], [1669017880000, 2.699], [1669017881000, 2.272], [1669017881000, 2.198], [1669017882000, 2.695], [1669017882000, 1.706], [1669017883000, 2.221], [1669017883000, 2.059], [1669017884000, 1.918], [1669017884000, 2.231], [1669017885000, 2.264], [1669017885000, 2.067], [1669017886000, 2.112], [1669017886000, 2.194], [1669017887000, 2.438], [1669017887000, 2], [1669017888000, 2.011], [1669017888000, 2.342], [1669017889000, 1.769], [1669017889000, 2.228], [1669017890000, 2.314], [1669017891000, 2.116], [1669017891000, 2.135], [1669017892000, 2.428], [1669017892000, 1.98], [1669017893000, 1.896], [1669017893000, 2.369], [1669017894000, 2.616], [1669017894000, 2.23], [1669017895000, 2.035], [1669017895000, 2.762], [1669017896000, 2.231], [1669017896000, 2.417], [1669017897000, 2.202], [1669017897000, 1.614], [1669017898000, 2.365], [1669017898000, 2.047], [1669017899000, 1.946], [1669017899000, 2.271], [1669017900000, 1.975], [1669017900000, 2.408], [1669017901000, 2.543], [1669017901000, 2.333], [1669017902000, 2.463], [1669017902000, 2.229], [1669017903000, 2.494], [1669017904000, 3.272], [1669017904000, 2.69], [1669017905000, 2.532], [1669017905000, 2.238], [1669017906000, 2.293], [1669017906000, 1.644], [1669017907000, 2.138], [1669017907000, 2.209], [1669017908000, 2.352], [1669017908000, 1.945], [1669017909000, 1.907], [1669017909000, 2.172], [1669017910000, 2.165], [1669017910000, 1.608], [1669017911000, 2.657], [1669017911000, 2.519], [1669017912000, 2.023], [1669017912000, 1.934], [1669017913000, 3.652], [1669017913000, 3.535], [1669017914000, 2.203], [1669017914000, 1.991], [1669017915000, 1.981], [1669017915000, 1.936], [1669017916000, 2.759], [1669017916000, 2.138], [1669017917000, 2.12], [1669017918000, 2.876], [1669017918000, 2.035], [1669017919000, 2.514], [1669017919000, 1.788], [1669017920000, 2.043], [1669017920000, 1.899], [1669017921000, 2.126], [1669017921000, 2.113], [1669017922000, 2.223], [1669017922000, 2.137], [1669017923000, 1.76], [1669017923000, 2.654], [1669017924000, 2.504], [1669017924000, 2.275], [1669017925000, 2.241], [1669017925000, 2.114], [1669017926000, 2.645], [1669017926000, 2.246], [1669017927000, 2.095], [1669017927000, 3.461], [1669017928000, 2.308], [1669017928000, 1.756], [1669017929000, 1.904], [1669017929000, 1.803], [1669017930000, 2.26], [1669017931000, 2.044], [1669017931000, 2.117], [1669017932000, 1.648], [1669017932000, 2.109], [1669017933000, 2.155], [1669017933000, 2.348], [1669017934000, 2.486], [1669017934000, 2.689], [1669017935000, 2.507], [1669017935000, 2.318], [1669017936000, 2.042], [1669017936000, 1.962], [1669017937000, 2.565], [1669017937000, 1.874], [1669017938000, 2.427], [1669017938000, 2.345], [1669017939000, 1.873], [1669017939000, 1.966], [1669017940000, 2.976], [1669017940000, 2.789], [1669017941000, 2.042], [1669017941000, 1.708], [1669017942000, 2.356], [1669017942000, 2.21], [1669017943000, 2.949], [1669017943000, 2.134], [1669017944000, 2.224], [1669017945000, 1.898], [1669017945000, 2.553], [1669017946000, 2.276], [1669017946000, 2.615], [1669017947000, 1.876], [1669017947000, 3.944], [1669017948000, 2.561], [1669017948000, 2.113], [1669017949000, 2.171], [1669017949000, 2.31], [1669017950000, 2.647], [1669017950000, 2.666], [1669017951000, 1.88], [1669017951000, 2.624], [1669017952000, 2.172], [1669017952000, 1.66], [1669017953000, 1.742], [1669017953000, 2.479], [1669017954000, 1.702], [1669017954000, 2.76], [1669017955000, 2.222], [1669017955000, 2.176], [1669017956000, 2.716], [1669017956000, 2.028], [1669017957000, 2.378], [1669017958000, 2.194], [1669017958000, 2.149], [1669017959000, 2.095], [1669017959000, 2.671], [1669017960000, 2.073], [1669017960000, 2.118], [1669017961000, 2.395], [1669017961000, 1.979], [1669017962000, 1.945], [1669017962000, 2.172], [1669017963000, 2.258], [1669017963000, 1.851], [1669017964000, 1.941], [1669017964000, 2.671], [1669017965000, 1.949], [1669017965000, 1.984], [1669017966000, 2.41], [1669017966000, 2.845], [1669017967000, 2.139], [1669017967000, 2.105], [1669017968000, 1.94], [1669017968000, 2.956], [1669017969000, 2.212], [1669017969000, 2.116], [1669017970000, 1.88], [1669017970000, 2.189], [1669017971000, 1.99], [1669017972000, 2.172], [1669017972000, 1.829], [1669017973000, 2.601], [1669017973000, 2.724], [1669017974000, 2.226], [1669017974000, 1.851], [1669017975000, 3.211], [1669017975000, 2.254], [1669017976000, 2.141], [1669017976000, 1.98], [1669017977000, 2.658], [1669017977000, 2.291], [1669017978000, 2.245], [1669017978000, 1.885], [1669017979000, 2.243], [1669017979000, 1.793], [1669017980000, 3.428], [1669017980000, 2.111], [1669017981000, 2.728], [1669017981000, 1.823], [1669017982000, 1.922], [1669017982000, 2.085], [1669017983000, 2.35], [1669017983000, 2.497], [1669017984000, 2.356], [1669017985000, 2.034], [1669017985000, 2.185], [1669017986000, 2.364], [1669017986000, 1.969], [1669017987000, 2.656], [1669017987000, 2.43], [1669017988000, 2.245], [1669017988000, 2.051], [1669017989000, 1.977], [1669017989000, 2.073], [1669017990000, 2.208], [1669017990000, 2.221], [1669017991000, 2.357], [1669017991000, 2.187], [1669017992000, 2.174], [1669017992000, 2.675], [1669017993000, 2.158], [1669017993000, 2.085], [1669017994000, 1.711], [1669017994000, 2.656], [1669017995000, 1.961], [1669017995000, 2.372], [1669017996000, 2.385], [1669017996000, 2.096], [1669017997000, 1.953], [1669017998000, 2.212], [1669017998000, 1.886], [1669017999000, 1.647], [1669017999000, 2.585], [1669018000000, 3.547], [1669018000000, 2.276], [1669018001000, 2.564], [1669018001000, 1.789], [1669018002000, 2.603], [1669018002000, 2.543], [1669018003000, 1.684], [1669018003000, 1.799], [1669018004000, 2.245], [1669018004000, 2.238], [1669018005000, 2.481], [1669018005000, 2.069], [1669018006000, 2.192], [1669018006000, 3.654], [1669018007000, 2.502], [1669018007000, 3.072], [1669018008000, 2.219], [1669018008000, 2.002], [1669018009000, 2.29], [1669018009000, 2.308], [1669018010000, 2.004], [1669018010000, 2.135], [1669018011000, 2.699], [1669018011000, 2.347], [1669018012000, 2.253], [1669018013000, 2.1], [1669018013000, 1.521], [1669018014000, 2.037], [1669018014000, 2.275], [1669018015000, 2.057], [1669018015000, 1.794], [1669018016000, 2.642], [1669018016000, 2.516], [1669018017000, 1.789], [1669018017000, 2.544], [1669018018000, 10.856], [1669018018000, 2.154], [1669018019000, 2.539], [1669018019000, 2.346], [1669018020000, 2.469], [1669018020000, 2.043], [1669018021000, 2.311]] }];

export const addSocket = (io) => {
  const pingLocation = async(location) => {
    while (locations.some(e => e.address === location.address)) {
      const address = location.address;

      try {
        const pingResult = await ping.promise.probe(address);
        const pingTime = pingResult.time;

        const history = location.history;
        const value = [
          moment().unix() * 1000,
          pingResult.alive ? pingTime : null
        ];

        history.push(value);

        io.emit('ping', {
          address,
          value
        });

        await new Promise((resolve) => setTimeout(resolve, 500));
      } catch (e) {
        io.emit('ping', {
          address,
          value: null
        });
      }
    }
  };

  const pingLocations = async() => {
    locations.forEach(location => {
      location.history.push(moment().unix() * 1000);
      pingLocation(location);
    });
  };

  pingLocations();

  io.on('connection', (socket) => {
    socket.emit('locations', locations);

    socket.on('addLocation', (location) => {
      if (!locations.some((l) => l.address === location)) {
        let addedLocation = {
          address: location,
          history: []
        };

        locations.push(addedLocation);

        io.emit('locations', locations);
        pingLocation(addedLocation);
      } else {
        socket.emit('error', 'location.exists');
      }
    });

    socket.on('removeLocation', (address) => {
      locations = locations.filter((l) => l.address !== address);

      io.emit('locations', locations);
    });
  });
};
